# ⏱️ API制限・遅延・頻度制限ガイド

**最終更新**: 2025年1月  
**バージョン**: 1.0

---

## 📋 目次

1. [現在の実装設定](#現在の実装設定)
2. [API呼び出し頻度制限](#api呼び出し頻度制限)
3. [遅延設定](#遅延設定)
4. [制限事項](#制限事項)
5. [推奨設定](#推奨設定)
6. [エラー時の対応](#エラー時の対応)

---

## ⚙️ 現在の実装設定

### 自動更新頻度

| 機能 | 更新間隔 | 実装場所 |
|------|---------|---------|
| **ポジション情報** | **5秒ごと** | `main.py:296` |
| **未約定注文リスト** | **10秒ごと** | `main.py:300`（5秒ごとの更新の2回に1回） |
| **レバレッジ情報** | **5秒ごと** | `main.py:296`（ポジション更新と同時） |
| **アカウント情報** | **5秒ごと** | `main.py:296`（ポジション更新と同時） |
| **価格ストリーム** | **リアルタイム** | WebSocket（`hyperliquid_api.py:725`） |

### 注文後の更新遅延

| 操作 | 更新タイミング | 実装場所 |
|------|--------------|---------|
| **成行注文** | **1秒後** | `main.py:95` |
| **指値注文** | **1秒後** | `main.py:120` |
| **注文キャンセル** | **1秒後** | `main.py:238` |
| **ポジション決済** | **50ms、300ms、800ms** | `main.py:211-213`（3回更新） |

### WebSocket再接続遅延

| 試行回数 | 待機時間 | 実装場所 |
|---------|---------|---------|
| **1〜3回** | **5秒** | `hyperliquid_api.py:780` |
| **4〜10回** | **10秒** | `hyperliquid_api.py:782` |
| **11回以降** | **25秒** | `hyperliquid_api.py:784` |

---

## 🚫 API呼び出し頻度制限

### Hyperliquid公式の制限（推定）

**⚠️ 注意**: Hyperliquidの公式APIドキュメントには明示的なレート制限が記載されていませんが、実運用から以下の制限が推測されます：

| エンドポイント | 推定制限 | 現在の実装 |
|--------------|---------|-----------|
| **注文送信** | **不明**（過度な連続送信は避ける） | ユーザー操作に依存 |
| **ポジション取得** | **約12回/分**以下推奨 | **12回/分**（5秒間隔）✅ |
| **未約定注文取得** | **約6回/分**以下推奨 | **6回/分**（10秒間隔）✅ |
| **アカウント情報取得** | **約12回/分**以下推奨 | **12回/分**（5秒間隔）✅ |

### HTTP 429エラー（Rate Limiting）

**発生条件**:
- APIリクエストが多すぎる場合
- サーバーが過負荷状態の場合

**検出方法**:
```python
# hyperliquid_api.py:271-273
if '429' in error_str:
    print("[警告] APIレートリミット: リクエストが多すぎます。15秒待機してください。")
```

**推奨対応**:
- **15秒以上待機**してから再試行
- リクエスト頻度を下げる

---

## ⏱️ 遅延設定

### 1. **ポジション更新遅延**

**設定**: `main.py:296`
```python
time.sleep(5)  # 5秒ごとに更新
```

**理由**:
- APIレートリミットを回避
- サーバー負荷を軽減
- リアルタイム性と安定性のバランス

**変更可能**: ✅ 可（ただし3秒未満は非推奨）

---

### 2. **未約定注文取得遅延**

**設定**: `main.py:300`
```python
# 10秒ごと（2回に1回）
self.update_positions(include_orders=(update_count % 2 == 0))
```

**理由**:
- 未約定注文は変更頻度が低い
- ポジション情報より優先度が低い
- レートリミット対策

**変更可能**: ✅ 可（ただし5秒未満は非推奨）

---

### 3. **注文後の更新遅延**

**設定**: `main.py:95, 120, 238`
```python
self.gui.root.after(1000, lambda: self.update_positions(...))  # 1秒後
```

**理由**:
- API側で注文が反映されるまでの時間
- データベースの更新待機

**変更可能**: ⚠️ 可（ただし500ms未満は非推奨）

---

### 4. **決済後の更新遅延**

**設定**: `main.py:211-213`
```python
self.gui.root.after(50, lambda: self.update_positions(...))    # 50ms後
self.gui.root.after(300, lambda: self.update_positions(...))   # 300ms後
self.gui.root.after(800, lambda: self.update_positions(...))   # 800ms後
```

**理由**:
- 決済は即座に反映される必要がある
- APIの遅延に対応するため3回更新
- 即座に反映されない場合に備える

**変更可能**: ✅ 可

---

### 5. **WebSocket再接続遅延**

**設定**: `config.py:51` + `hyperliquid_api.py:779-787`

**段階的遅延**:
```python
if reconnect_count <= 3:
    wait_time = 5  # 5秒
elif reconnect_count <= 10:
    wait_time = 10  # 10秒
else:
    wait_time = 25  # 25秒
```

**理由**:
- 一時的なネットワーク障害に対応
- サーバー負荷を考慮した段階的再接続
- 無限ループを防ぐ

**変更可能**: ✅ 可（`Config.WS_RECONNECT_DELAY`を変更）

---

## 🚨 制限事項

### 1. **同時注文数の制限**

**制限**: 明確な制限はなし（ただし実用的な制限あり）

**推奨**:
- 連続注文は**1秒に1回まで**
- バッチ処理を使用する場合は最大10件まで

**実装**:
```python
# 全決済時は並列処理（最大10スレッド）
with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
    ...
```

---

### 2. **最小注文額**

**制限**: **$10以上**

**実装**:
```python
# gui.py:1019-1024
if order_value < 10.0:
    warning_label.configure(
        text=f"❌ 決済額: ${order_value:.2f} (最低$10必要)"
    )
    confirm_button.configure(state="disabled")
```

**対応**: 
- サイズを増やす
- 価格の高い通貨を選ぶ

---

### 3. **WebSocket接続数**

**制限**: 1アカウント1接続

**実装**:
- アプリケーション起動時に1つのWebSocket接続を確立
- `allMids`チャンネルで全通貨ペアの価格を取得

---

### 4. **APIレスポンス待機時間**

**制限**: 明確なタイムアウトはなし（デフォルトは30秒程度）

**推奨**:
- 長時間応答がない場合は接続を切断して再試行
- エラーハンドリングで適切に対応

---

## ✅ 推奨設定

### 安全な更新頻度

| 機能 | 推奨間隔 | 最大頻度 | 現在の設定 |
|------|---------|---------|-----------|
| **ポジション更新** | **5秒** | 3秒 | ✅ 5秒 |
| **未約定注文取得** | **10秒** | 5秒 | ✅ 10秒 |
| **レバレッジ取得** | **5秒** | 3秒 | ✅ 5秒 |
| **アカウント情報取得** | **5秒** | 3秒 | ✅ 5秒 |

### 注文操作の推奨頻度

| 操作 | 推奨間隔 | 理由 |
|------|---------|------|
| **連続注文** | **1秒以上** | サーバー負荷軽減 |
| **注文キャンセル** | **0.5秒以上** | API処理時間考慮 |
| **決済操作** | **即座に可能** | 優先度が高い |

---

## 🔧 設定の変更方法

### 1. ポジション更新頻度の変更

**ファイル**: `main.py:296`
```python
# 5秒 → 3秒に変更（より頻繁に更新）
time.sleep(3)  # 変更前: time.sleep(5)
```

**⚠️ 注意**: 
- 3秒未満は非推奨（レートリミットのリスク）
- 変更後はHTTP 429エラーを監視

---

### 2. 未約定注文取得頻度の変更

**ファイル**: `main.py:300`
```python
# 10秒ごと → 5秒ごとに変更
self.update_positions(include_orders=(update_count % 1 == 0))  # 毎回
# または
# 15秒ごとに変更
self.update_positions(include_orders=(update_count % 3 == 0))  # 3回に1回
```

---

### 3. 注文後の更新遅延の変更

**ファイル**: `main.py:95, 120, 238`
```python
# 1秒 → 500msに変更（より早く更新）
self.gui.root.after(500, lambda: self.update_positions(...))  # 変更前: 1000
```

**⚠️ 注意**: 
- 500ms未満は非推奨（API反映前の更新になる可能性）
- 変更後はデータの整合性を確認

---

### 4. WebSocket再接続遅延の変更

**ファイル**: `config.py:51`
```python
WS_RECONNECT_DELAY = 3  # 変更前: 5秒
```

**影響**:
- 再接続がより頻繁になる（サーバー負荷増加の可能性）
- ネットワーク障害からの回復が早くなる

---

## 📊 エラー時の対応

### HTTP 429エラー（Rate Limiting）

**症状**:
```
[警告] APIレートリミット: リクエストが多すぎます。15秒待機してください。
```

**対応**:
1. **15秒以上待機**
2. リクエスト頻度を下げる
3. エラーが続く場合は更新頻度を変更

**自動対応**:
- エラー検出時に警告を表示
- 自動再試行は実装されていない（手動対応が必要）

---

### WebSocket切断

**症状**:
```
WebSocket接続が切断されました（試行 X回目）
```

**対応**:
- 自動再接続が実行される
- 段階的な遅延で再接続（5秒 → 10秒 → 25秒）

**手動対応**:
- 必要に応じてアプリケーションを再起動

---

### 注文が反映されない

**症状**:
- GUIで注文を送信したが、ポジションが更新されない

**対応**:
1. **1秒待機**してから再確認（API反映時間）
2. 手動でポジション更新（GUIの「全検査E」ボタン）
3. ログを確認（エラーメッセージの有無）

**実装**:
```python
# 決済後は3回更新して確実に反映
self.gui.root.after(50, lambda: self.update_positions(...))    # 即座
self.gui.root.after(300, lambda: self.update_positions(...))   # 0.3秒後
self.gui.root.after(800, lambda: self.update_positions(...))   # 0.8秒後
```

---

## 🎯 最適化のヒント

### 1. **頻度のトレードオフ**

| 高頻度更新 | 低頻度更新 |
|-----------|-----------|
| ✅ リアルタイム性が高い | ✅ サーバー負荷が低い |
| ✅ レスポンスが速い | ✅ レートリミット回避 |
| ❌ レートリミットのリスク | ❌ 情報が古い可能性 |

**推奨**: 現在の設定（5秒/10秒）が最適なバランス

---

### 2. **注文操作の最適化**

**推奨パターン**:
```python
# ✅ 良い例: 適切な間隔で注文
place_order("BTC", True, 0.01)
time.sleep(1)  # 1秒待機
place_order("ETH", True, 0.01)

# ❌ 悪い例: 連続注文
place_order("BTC", True, 0.01)
place_order("ETH", True, 0.01)  # 即座に実行（レートリミットのリスク）
```

---

### 3. **並列処理の活用**

**全決済時の並列処理**:
```python
# 最大10スレッドで並列決済
with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
    ...
```

**注意**: 
- 最大10スレッドは安全な設定
- これ以上増やすとレートリミットのリスク

---

## 📈 パフォーマンス監視

### 推奨監視項目

1. **HTTP 429エラーの発生頻度**
   - 頻発する場合は更新頻度を下げる

2. **WebSocket切断の発生頻度**
   - 頻発する場合はネットワークを確認

3. **ポジション更新の遅延**
   - GUIと実際のポジションのずれを確認

4. **注文反映時間**
   - 注文送信から反映までの時間を測定

---

## 📝 まとめ

### 現在の設定（推奨）

| 項目 | 設定値 | 状態 |
|------|--------|------|
| **ポジション更新** | 5秒ごと | ✅ 最適 |
| **未約定注文取得** | 10秒ごと | ✅ 最適 |
| **注文後更新** | 1秒後 | ✅ 適切 |
| **決済後更新** | 50ms、300ms、800ms | ✅ 適切 |
| **WebSocket再接続** | 5秒→10秒→25秒 | ✅ 適切 |

### 変更時の注意点

1. **頻度を上げる場合**:
   - HTTP 429エラーを監視
   - サーバー負荷を考慮

2. **頻度を下げる場合**:
   - 情報の鮮度が低下する可能性
   - ユーザー体験に影響

3. **新機能追加時**:
   - 既存の更新頻度との整合性を確認
   - レートリミットの総合的な影響を考慮

---

**仕様書バージョン**: 1.0  
**最終更新**: 2025年1月

